{% comment %}
  Renders cart drawer

  Usage:
  {% render 'cart-drawer' %}
{% endcomment %}

<style>
  .drawer {
    visibility: hidden;
  }
  {% if section.settings.enable_header_bg %}
    .cart-drawer .drawer__header {
      background: {{ section.settings.header_bg_color }};
    }
  {% endif %}
  {% if section.settings.enable_body_bg %}
    .cart-drawer__body, .cart-drawer-item {
      background: {{ section.settings.body_bg_color }};
    }
    /* Empty state background */
    .drawer__inner-empty {
      background: {{ section.settings.body_bg_color }};
    }
  {% endif %}
  {% if section.settings.enable_footer_bg %}
    .cart-drawer .drawer__footer {
      background: {{ section.settings.footer_bg_color }};
    }
  {% endif %}

  /* Aesthetic Enhancements */
  {% if section.settings.enable_typography_enhancements %}
    /* Enhanced Typography */
    .cart-drawer .drawer__heading {
      font-family: {{ section.settings.heading_font.family }}, {{ section.settings.heading_font.fallback_families }};
      font-weight: {{ section.settings.heading_font.weight }};
      font-style: {{ section.settings.heading_font.style }};
      letter-spacing: {{ section.settings.heading_letter_spacing }}em;
      font-size: {{ section.settings.heading_font_size }}rem;
    }

    .cart-timer {
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    .cart-drawer__totals__row__money {
      font-weight: 700;
      font-size: 0.95em;
    }

    .cart-item__name {
      font-weight: 600;
      letter-spacing: 0.01em;
    }
  {% endif %}

  {% if section.settings.enable_product_card_polish %}
    /* Product Card Polish */
    .cart-drawer-item {
      border-radius: {{ section.settings.product_card_radius }}px;
      box-shadow: {{ section.settings.product_card_shadow }};
      padding: {{ section.settings.product_card_padding }}px;
      margin-bottom: {{ section.settings.product_card_margin }}px;
      transition: box-shadow 0.3s ease, transform 0.2s ease;
    }

    .cart-drawer-item:hover {
      box-shadow: {{ section.settings.product_card_shadow_hover }};
      transform: translateY(-2px);
    }

    .cart-item__image {
      border-radius: {{ section.settings.product_image_radius }}px;
    }
  {% endif %}

  {% if section.settings.enable_visual_dividers %}
    /* Visual Dividers */
    .cart-drawer-item:not(:last-child) {
      border-bottom: {{ section.settings.divider_thickness }}px solid {{ section.settings.divider_color }};
      padding-bottom: {{ section.settings.divider_padding }}px;
    }

    .drawer__footer::before {
      content: '';
      display: block;
      height: {{ section.settings.divider_thickness }}px;
      background: linear-gradient(90deg, transparent, {{ section.settings.divider_color }}, transparent);
      margin: -{{ section.settings.divider_padding }}px 0 {{ section.settings.divider_padding }}px;
      opacity: 0.5;
    }
  {% endif %}

  /* Countdown Timer Styles */
  .cart-timer {
    background-color: var(--timer-bg, #7B92C8) !important;
    padding: var(--timer-padding-y, 12px) var(--timer-padding-x, 15px) !important;
    text-align: var(--timer-align, center) !important;
  }

  {% if section.settings.enable_timer_pulse %}
    {% assign pulse_intensity = section.settings.timer_pulse_intensity | default: 25 %}
    {% assign pulse_speed = section.settings.timer_pulse_speed | default: 1.5 %}
    .cart-timer {
      animation: cartTimerPulse {{ pulse_speed }}s ease-in-out infinite;
    }

    @keyframes cartTimerPulse {
      0%, 100% {
        box-shadow: 0 0 0 0 {{ section.settings.timer_pulse_color | default: '#7B92C8' | append: '99' }};
      }
      50% {
        box-shadow: 0 0 {{ pulse_intensity }}px {{ pulse_intensity | divided_by: 3 }}px {{ section.settings.timer_pulse_color | default: '#7B92C8' | append: 'CC' }}, 0 0 {{ pulse_intensity | times: 1.6 }}px {{ pulse_intensity | divided_by: 1.6 }}px {{ section.settings.timer_pulse_color | default: '#7B92C8' | append: '66' }};
      }
    }
  {% endif %}

  /* Sticky Footer on Mobile */
  {% if section.settings.enable_sticky_footer_mobile %}
    @media screen and (max-width: 749px) {
      .cart-drawer .drawer__footer {
        position: sticky;
        bottom: 0;
        z-index: 10;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
      }
    }
  {% endif %}

  /* Enhanced Empty Cart State */
  {% if section.settings.enable_enhanced_empty_cart %}
    .drawer__inner-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px 20px;
    }

    .cart-drawer__empty-content {
      max-width: 280px;
    }

    .cart__empty-text {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: {{ section.settings.empty_cart_text_color }};
    }

    .cart-drawer__empty-icon {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .cart-drawer__empty-cta {
      margin-top: 20px;
    }

    .cart-drawer__featured-products {
      margin-top: 30px;
      width: 100%;
    }

    .cart-drawer__featured-products-title {
      font-size: 1rem;
      margin-bottom: 15px;
      color: {{ section.settings.empty_cart_text_color }};
    }
  {% endif %}

  /* Trust Signals Styling */
  {% if section.settings.enable_trust_signals %}
    .cart-drawer__trust-signals {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 15px;
      background: {{ section.settings.trust_signals_bg | default: 'rgba(0,0,0,0.03)' }};
      border-radius: 8px;
      margin-top: var(--margin-top, 0);
      margin-bottom: var(--margin-bottom, 0);
    }

    .cart-drawer__trust-signal {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.85rem;
      color: {{ section.settings.trust_signals_text_color | default: 'inherit' }};
    }

    .cart-drawer__trust-signal svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
      color: {{ section.settings.trust_signals_icon_color | default: '#7B92C8' }};
    }

    @media screen and (min-width: 750px) {
      .cart-drawer__trust-signals {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
      }
    }
  {% endif %}

  /* Trust Badges Styling */
  {% if section.settings.enable_trust_badges_footer %}
    .cart-drawer__trust-badges {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(0,0,0,0.1);
    }

    .cart-drawer__trust-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: {{ section.settings.trust_badge_text_color }};
    }

    .cart-drawer__trust-badge svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }
  {% endif %}

  /* In-Cart Upsell Styling */
  .cart-drawer__in-cart-upsell {
    background: var(--icup-bg, #F8F8F8);
    border: 1px solid var(--icup-border, #E0E0E0);
    border-radius: var(--icup-radius, 8px);
    padding: var(--icup-padding, 16px);
    margin-top: var(--icup-margin-top, 16px);
    margin-bottom: var(--icup-margin-bottom, 16px);
    transition: box-shadow 0.2s ease, border-color 0.2s ease;
  }

  .cart-drawer__in-cart-upsell:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border-color: var(--icup-accent, #7B92C8);
  }

  .cart-drawer__in-cart-upsell__label {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    cursor: pointer;
    margin: 0;
  }

  .cart-drawer__in-cart-upsell__checkbox {
    appearance: none;
    -webkit-appearance: none;
    width: 22px;
    height: 22px;
    min-width: 22px;
    border: 2px solid var(--icup-checkbox, #7B92C8);
    border-radius: 4px;
    background: #fff;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
    margin-top: 2px;
  }

  .cart-drawer__in-cart-upsell__checkbox:checked {
    background: var(--icup-checkbox, #7B92C8);
  }

  .cart-drawer__in-cart-upsell__checkbox:checked::after {
    content: '';
    position: absolute;
    left: 5px;
    top: 1px;
    width: 6px;
    height: 12px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

  .cart-drawer__in-cart-upsell__checkbox:focus {
    outline: 2px solid var(--icup-accent, #7B92C8);
    outline-offset: 2px;
  }

  .cart-drawer__in-cart-upsell__checkbox:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .cart-drawer__in-cart-upsell__content {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
  }

  .cart-drawer__in-cart-upsell__icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    color: var(--icup-accent, #7B92C8);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .cart-drawer__in-cart-upsell__icon svg {
    width: 100%;
    height: 100%;
  }

  .cart-drawer__in-cart-upsell__text {
    font-size: 0.95rem;
    color: var(--icup-text, #333333);
    line-height: 1.4;
  }

  .cart-drawer__in-cart-upsell__price {
    font-weight: 700;
    color: var(--icup-accent, #7B92C8);
    margin-left: 4px;
  }

  /* Loading state for upsell */
  .cart-drawer__in-cart-upsell.is-loading {
    opacity: 0.7;
    pointer-events: none;
  }

  .cart-drawer__in-cart-upsell.is-loading .cart-drawer__in-cart-upsell__checkbox {
    animation: checkboxPulse 1s ease-in-out infinite;
  }

  @keyframes checkboxPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Success state */
  .cart-drawer__in-cart-upsell.is-added {
    background: #e8f5e9;
    border-color: #4caf50;
  }

  .cart-drawer__in-cart-upsell.is-added .cart-drawer__in-cart-upsell__text::after {
    content: ' âœ“ Added';
    color: #4caf50;
    font-weight: 600;
    font-size: 0.85em;
  }
</style>

<cart-drawer class="drawer{% if cart == empty %} is-empty{% endif %}{% if section.settings.test_mode %} active{% endif %} cart-drawer--desktop-width-{{ section.settings.desktop_width }} cart-drawer--mobile-width-{{ section.settings.mobile_width }}" data-type='modal'>
  <div id="CartDrawer" class="cart-drawer">
    <div id="CartDrawer-Overlay" class="cart-drawer__overlay"></div>
    <div
      class="drawer__inner"
      role="dialog"
      aria-modal="true"
      aria-label="{{ 'sections.cart.title' | t }}"
      tabindex="-1"
    >
      {%- if cart == empty -%}
        <div class="drawer__inner-empty">
          <div class="cart-drawer__warnings center{% if settings.cart_drawer_collection != blank %} cart-drawer__warnings--has-collection{% endif %}">
            <div class="cart-drawer__empty-content">
              {% if section.settings.enable_enhanced_empty_cart %}
                <div class="cart-drawer__empty-icon">
                  {% render 'icon-cart-empty' %}
                </div>
                <h2 class="cart__empty-text">{{ section.settings.empty_cart_heading | default: 'Your cart is empty' }}</h2>
                <p class="cart-drawer__empty-subtext">{{ section.settings.empty_cart_subtext | default: 'Discover our products and find something you love!' }}</p>
                <div class="cart-drawer__empty-cta">
                  <a href="{% if section.settings.empty_cart_cta_url != blank %}{{ section.settings.empty_cart_cta_url }}{% else %}{{ routes.all_products_collection_url }}{% endif %}" class="button button--primary">
                    {{ section.settings.empty_cart_cta_text | default: 'Start Shopping' }}
                  </a>
                </div>
                {% if section.settings.empty_cart_featured_collection != blank %}
                  <div class="cart-drawer__featured-products">
                    <p class="cart-drawer__featured-products-title">{{ section.settings.empty_cart_featured_title | default: 'Popular products' }}</p>
                    <div class="cart-drawer__featured-grid">
                      {% for product in section.settings.empty_cart_featured_collection.products limit: 2 %}
                        {% render 'card-product', card_product: product, media_aspect_ratio: 'adapt', show_secondary_image: false, show_vendor: false, show_rating: false %}
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
              {% else %}
                <h2 class="cart__empty-text">{{ 'sections.cart.empty' | t }}</h2>
                {% if settings.display_continue_shopping %}
                  <a href="{% if settings.continue_shopping_url == blank %}{{ routes.all_products_collection_url }}{% else %}{{ settings.continue_shopping_url }}{% endif %}" class="button">
                    {{ 'general.continue_shopping' | t }}
                  </a>
                {% endif %}

                {%- if shop.customer_accounts_enabled and customer == null -%}
                  <p class="cart__login-title h3">{{ 'sections.cart.login.title' | t }}</p>
                  <p class="cart__login-paragraph">
                    {{ 'sections.cart.login.paragraph_html' | t: link: routes.account_login_url }}
                  </p>
                {%- endif -%}
              {% endif %}
              <button
                class="drawer__close"
                type="button"
                onclick="this.closest('cart-drawer').close()"
                aria-label="{{ 'accessibility.close' | t }}"
              >
                {% render 'icon-close' %}
              </button>
            </div>
          </div>
          {%- if settings.cart_drawer_collection != blank -%}
            <div class="cart-drawer__collection">
              {% render 'card-collection', card_collection: settings.cart_drawer_collection, columns: 1 %}
            </div>
          {%- endif -%}
        </div>
      {%- endif -%}
      <div class="drawer__header" style='--alignment:{{ section.settings.heading_alignment }}'>
        <h2 class="drawer__heading">
          {% liquid
            assign non_upsell_count = cart.item_count
            for item in cart.items
              if item.product.tags contains 'cart-hidden'
                assign non_upsell_count = non_upsell_count | minus: 1
              endif
            endfor
          %}
          {% liquid
            assign item_text = 'items'
            if non_upsell_count == 1
              assign item_text = 'item'
            endif
          %}
          {{ section.settings.heading_text | replace: '[count]', non_upsell_count | replace: '[items]', item_text }}
        </h2>
        <button
          class="drawer__close"
          type="button"
          onclick="this.closest('cart-drawer').close()"
          aria-label="{{ 'accessibility.close' | t }}"
        >
          {% render 'icon-close' %}
        </button>
      </div>
      <div class="cart-drawer__body">
        {% if section.blocks.size == 0 %}
          <h3 class='h3 center'>To customize the cart, add blocks to the Cart drawer section (under the Header group)</h3>
        {% endif %}
        {% assign total_compare_price = 0 %}
        {% for block in section.blocks %}
          {% case block.type %}
            {% when 'progress_bar' %}
              {% render 'cart-progress-bar', block: block, items_count: non_upsell_count %}
            {% when 'checkpoints_bar' %}
              {% render 'cart-checkpoints-bar', block: block, items_count: non_upsell_count %}
            {% when 'countdown_timer' %}
              {% capture timer %}
                <countdown-timer data-duration="{{ block.settings.timer_duration }}" data-auto-play="true" data-clear-cart="{{ block.settings.clear_cart_on_expire }}"></countdown-timer>
              {% endcapture %}
              <div class='cart-timer color-{{ block.settings.color_scheme }}' style="--font-size:{{ block.settings.font_size }}rem;--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;--timer-bg:{{ block.settings.background_color }};--timer-padding-y:{{ block.settings.padding_vertical }}px;--timer-padding-x:{{ block.settings.padding_horizontal }}px;--timer-align:{{ block.settings.text_alignment }};" {{ block.shopify_attributes }}>
                {{ block.settings.timer_text | replace: '[timer]', timer }}
              </div>
            {% when 'cart_items' %}
              <cart-drawer-items
                {% if cart == empty %}
                  class=" is-empty"
                {% endif %}
                style="--image-size: {{ block.settings.image_size }}%;--title-size:{{ block.settings.title_size }}rem;--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" 
                {{ block.shopify_attributes }}
              >
                <form
                  action="{{ routes.cart_url }}"
                  id="CartDrawer-Form"
                  class="cart__contents cart-drawer__form"
                  method="post"
                >
                  <div id="CartDrawer-CartItems" class="drawer__contents js-contents">
                    {%- if cart != empty -%}
                      <div class="drawer__cart-items-wrapper">
                        <ul class="cart-items list-unstyled">
                          {%- for item in cart.items -%}
                            <li
                              id="CartDrawer-Item-{{ item.index | plus: 1 }}"
                              class="cart-drawer-item cart-item cart-item--product-{{ item.product.handle }}"
                              role="row" data-index="{{ item.index | plus: 1 }}"
                              data-quantity="{{ item.quantity }}"
                              data-variant-id="{{ item.variant_id }}"
                              data-key="{{ item.key }}"
                            >
                              <div class="loading-overlay hidden">
                                <div class="loading-overlay__spinner">
                                  <svg
                                    aria-hidden="true"
                                    focusable="false"
                                    class="spinner"
                                    viewBox="0 0 66 66"
                                    xmlns="http://www.w3.org/2000/svg"
                                  >
                                    <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                                  </svg>
                                </div>
                              </div>
                              <div class="cart-item__media" role="cell">
                                {% if item.image %}
                                  {% comment %} Leave empty space due to a:empty CSS display: none rule {% endcomment %}
                                  {% if block.settings.image_link %}<a href="{{ item.url }}" class="cart-item__link" tabindex="-1" aria-hidden="true"> </a>{% endif %}
                                  <img
                                    class="cart-item__image"
                                    src="{{ item.image | image_url: width: 300 }}"
                                    alt="{{ item.image.alt | escape }}"
                                    loading="lazy"
                                    width="150"
                                    height="{{ 150 | divided_by: item.image.aspect_ratio | ceil }}"
                                  >
                                {% endif %}
                              </div>

                              <div class='cart-drawer-item__right'>
                                {% liquid 
                                  assign display_compare = false
                                  assign compare_price = 0
                                  assign has_props = false
                                  for variant in item.product.variants
                                    if variant.id == item.id 
                                      assign current_variant = variant
                                    endif
                                  endfor
                                  
                                  if block.settings.displayed_compare_prices == 'automatic'
                                    if item.original_line_price != item.final_line_price 
                                      assign display_compare = true
                                      assign compare_price = item.original_line_price
                                    elsif current_variant.compare_at_price > item.final_price
                                      assign display_compare = true
                                      assign compare_price = current_variant.compare_at_price | times: item.quantity
                                    endif
                                  elsif block.settings.displayed_compare_prices == 'product' and current_variant.compare_at_price > item.final_price
                                    assign display_compare = true
                                    assign compare_price = current_variant.compare_at_price | times: item.quantity
                                  elsif item.original_line_price != item.final_line_price
                                    assign display_compare = true
                                    assign compare_price = item.original_line_price
                                  endif
                                %}
                                <div class='cart-drawer-item__details-and-delete-btn'>
                                  <div class="cart-item__details" role="cell" headers="CartDrawer-ColumnProduct">
                                    {%- if settings.show_vendor -%}
                                      <p class="caption-with-letter-spacing light">{{ item.product.vendor }}</p>
                                    {%- endif -%}
        
                                    <{% if block.settings.title_link %}a href="{{ item.url }}"{% else %}h4{% endif %} class="cart-item__name h4 break">
                                      {{- item.product.title | escape -}}
                                    </{% if block.settings.title_link %}a{% else %}h4{% endif %}>
        
                                    {%- if item.original_price != item.final_price and block.settings.display_single_item_prices -%}
                                      {% assign has_props = true %}
                                      <div class="cart-item__discounted-prices cart-drawer-item__single-item-prices">
                                        <span>
                                          <span class="visually-hidden">
                                            {{ 'products.product.price.regular_price' | t }}
                                          </span>
                                          <s class="cart-item__old-price product-option text-color-{{ block.settings.compare_price_color }}">
                                            {{- compare_price | divided_by: item.quantity | money -}}
                                          </s>
                                          <span class="visually-hidden">
                                            {{ 'products.product.price.sale_price' | t }}
                                          </span>
                                          <strong class="cart-item__final-price product-option text-color-{{ block.settings.price_color }}">
                                            {{ item.final_price | money }}
                                          </strong>
                                        </span>
                                        <div class="cart-drawer__discounts list-unstyled" role="list" aria-label="{{ 'customer.order.discount' | t }}">
                                          {%- for discount in item.discounts -%}
                                            <div class="badge">
                                              {%- render 'icon-discount' -%}
                                              <span>{{ discount.title }}</span>
                                            </div>
                                          {%- endfor -%}
                                        </div>
                                      </div>
                                    {%- endif -%}
        
                                    {%- if item.product.has_only_default_variant == false
                                      or item.properties != blank
                                      or item.selling_plan_allocation != null
                                    -%}
                                      {% assign has_props = true %}
                                      <dl>
                                        {%- if item.product.has_only_default_variant == false -%}
                                          {% if block.settings.displayed_variants == 'compact' %}
                                            <div class="product-option">
                                              {{ item.options_with_values | map: 'value' | join: ' / ' }}
                                            </div>
                                          {% else %}
                                            {%- for option in item.options_with_values -%}
                                              <div class="product-option">
                                                <dt>{{ option.name }}:</dt>
                                                <dd>
                                                  {{ option.value -}}
                                                  {%- unless forloop.last %}, {% endunless %}
                                                </dd>
                                              </div>
                                            {%- endfor -%}
                                          {% endif %}
                                        {%- endif -%}
        
                                        {%- for property in item.properties -%}
                                          {%- assign property_first_char = property.first | slice: 0 -%}
                                          {%- if property.last != blank and property_first_char != '_' -%}
                                            <div class="product-option">
                                              <dt>{{ property.first }}:</dt>
                                              <dd>
                                                {%- if property.last contains '/uploads/' -%}
                                                  <a
                                                    href="{{ property.last }}"
                                                    class="link"
                                                    target="_blank"
                                                    aria-describedby="a11y-new-window-message"
                                                  >
                                                    {{ property.last | split: '/' | last }}
                                                  </a>
                                                {%- else -%}
                                                  {{ property.last }}
                                                {%- endif -%}
                                              </dd>
                                            </div>
                                          {%- endif -%}
                                        {%- endfor -%}
                                      </dl>
        
                                      <p class="product-option">{{ item.selling_plan_allocation.selling_plan.name }}</p>
                                    {%- endif -%}
                                  </div>
                                  <cart-remove-button
                                    class='cart-drawer-item__cart-remove-button'
                                    id="CartDrawer-Remove-{{ item.index | plus: 1 }}"
                                    data-index="{{ item.index | plus: 1 }}"
                                    data-line-item-key="{{ item.key }}"
                                  >
                                    <button
                                      type="button"
                                      class="button button--tertiary"
                                      aria-label="{{ 'sections.cart.remove_title' | t: title: item.title }}"
                                    >
                                      {% render 'icon-remove' %}
                                    </button>
                                  </cart-remove-button>
                                </div>

                                <div class='cart-drawer-item__quantity-and-prices{% if block.settings.prices_position == 'left' %} cart-drawer-item__quantity-and-prices--reverse{% endif %}{% if has_props != false %} cart-drawer-item__quantity-and-prices--has-props{% endif %}'>
                                  <div class="cart-item__quantity">
                                    <div class="cart-item__quantity-wrapper">
                                      <quantity-input 
                                        class="quantity cart-quantity color-{{ block.settings.quantity_container_color_scheme }}{% if block.settings.quantity_round_btns %} cart-quantity--round-btns{% endif %}{% if block.settings.quantity_outline_btns %} cart-quantity--outline-btns{% endif %}"
                                        style='
                                          --font-size:{{ block.settings.quantity_font_size | divided_by: 10.0 }}rem;
                                          --border-width:0.{{ block.settings.quantity_border_width }}rem;
                                          --border-color:{{ block.settings.quantity_border_color }};
                                          --corner-radius:{{ block.settings.quantity_corner_radius | divided_by: 10.0 }}rem;
                                          --container-padding:{{ block.settings.quantity_container_padding }}em;
                                          --input-padding:{{ block.settings.quantity_input_padding }}em;
                                          --separator-opacity:{{ block.settings.quantity_separators_opacity | divided_by: 100.0 }};
                                          --padding:{{ block.settings.quantity_padding }}em;
                                          --icon-size:{{ block.settings.quantity_btns_icon_size | divided_by: 100.0 }}em;
                                        '
                                      >
                                        <button class="quantity__button quantity__button--minus no-js-hidden color-{{ block.settings.quantity_btns_color_scheme }}" name="minus" type="button">
                                          <span class="visually-hidden">
                                            {{-
                                              'products.product.quantity.decrease'
                                              | t: product: item.product.title
                                              | escape
                                            -}}
                                          </span>
                                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill='currentColor'>
                                            <path d="M432 256c0 17.7-14.3 32-32 32L48 288c-17.7 0-32-14.3-32-32s14.3-32 32-32l352 0c17.7 0 32 14.3 32 32z"/>
                                          </svg>
                                        </button>
                                        <input
                                          class="quantity__input"
                                          type="number"
                                          data-quantity-variant-id="{{ item.variant.id }}"
                                          name="updates[]"
                                          value="{{ item.quantity }}"
                                          {% # theme-check-disable %}
                                          data-cart-quantity="{{ cart | item_count_for_variant: item.variant.id }}"
                                          min="{{ item.variant.quantity_rule.min }}"
                                          {% if item.variant.quantity_rule.max != null %}
                                            max="{{ item.variant.quantity_rule.max }}"
                                          {% endif %}
                                          step="{{ item.variant.quantity_rule.increment }}"
                                          {% # theme-check-enable %}
                                          aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
                                          id="Drawer-quantity-{{ item.index | plus: 1 }}"
                                          data-index="{{ item.index | plus: 1 }}"
                                          data-line-item-key="{{ item.key }}"
                                        >
                                        <button class="quantity__button quantity__button--plus no-js-hidden color-{{ block.settings.quantity_btns_color_scheme }}" name="plus" type="button">
                                          <span class="visually-hidden">
                                            {{-
                                              'products.product.quantity.increase'
                                              | t: product: item.product.title
                                              | escape
                                            -}}
                                          </span>
                                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill='currentColor'>
                                            <path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/>
                                          </svg>
                                        </button>
                                      </quantity-input>
                                    </div>
        
                                    <div
                                      id="CartDrawer-LineItemError-{{ item.index | plus: 1 }}"
                                      class="cart-item__error"
                                      role="alert"
                                    >
                                      <small class="cart-item__error-text"></small>
                                      <svg
                                        aria-hidden="true"
                                        focusable="false"
                                        class="icon icon-error"
                                        viewBox="0 0 13 13"
                                      >
                                        <circle cx="6.5" cy="6.50049" r="5.5" stroke="white" stroke-width="2"/>
                                        <circle cx="6.5" cy="6.5" r="5.5" fill="#EB001B" stroke="#EB001B" stroke-width="0.7"/>
                                        <path d="M5.87413 3.52832L5.97439 7.57216H7.02713L7.12739 3.52832H5.87413ZM6.50076 9.66091C6.88091 9.66091 7.18169 9.37267 7.18169 9.00504C7.18169 8.63742 6.88091 8.34917 6.50076 8.34917C6.12061 8.34917 5.81982 8.63742 5.81982 9.00504C5.81982 9.37267 6.12061 9.66091 6.50076 9.66091Z" fill="white"/>
                                        <path d="M5.87413 3.17832H5.51535L5.52424 3.537L5.6245 7.58083L5.63296 7.92216H5.97439H7.02713H7.36856L7.37702 7.58083L7.47728 3.537L7.48617 3.17832H7.12739H5.87413ZM6.50076 10.0109C7.06121 10.0109 7.5317 9.57872 7.5317 9.00504C7.5317 8.43137 7.06121 7.99918 6.50076 7.99918C5.94031 7.99918 5.46982 8.43137 5.46982 9.00504C5.46982 9.57872 5.94031 10.0109 6.50076 10.0109Z" fill="white" stroke="#EB001B" stroke-width="0.7">
                                      </svg>
                                    </div>
                                  </div>
                                  
                                  <div class="cart-item__totals {{ block.settings.prices_position }}" role="cell">
                                    <div class="cart-item__price-wrapper">
                                      {% if display_compare %}
                                        {% liquid
                                          assign item_saving = compare_price | minus: item.final_line_price
                                          assign total_compare_price = total_compare_price | plus: compare_price
                                        %}
                                        <div class="cart-item__discounted-prices">
                                          <span class="visually-hidden">{{ 'products.product.price.regular_price' | t }}</span>
                                          <s class="cart-item__old-price price--end compare-price color-foreground-{{ block.settings.compare_price_color }}">
                                            {{ compare_price | money }}
                                          </s>
                                          <span class="visually-hidden">{{ 'products.product.price.sale_price' | t }}</span>
                                          <span class="price--end regular-price accent-color-{{ block.settings.price_color }}">
                                            {{ item.final_line_price | money }}
                                          </span>
                                        </div>
                                        {% if block.settings.enable_savings %}
                                          <span class='cart-drawer-item__saving text-color-{{ block.settings.savings_color }}'>
                                            {% capture saved_money_span  %}{{ item_saving | money_without_trailing_zeros }}{% endcapture %}
                                            {{ block.settings.savings_text | replace: '[amount]', saved_money_span }}
                                          </span>
                                        {% endif %}
                                      {% else %}
                                        {% liquid
                                          assign total_compare_price = total_compare_price | plus: item.original_line_price
                                        %}
                                        <span class="price--end regular-price accent-color-{{ block.settings.price_color }}">
                                          {{ item.original_line_price | money }}
                                        </span>
                                      {% endif %}
        
                                      {%- if item.variant.available and item.unit_price_measurement -%}
                                        <div class="unit-price caption">
                                          <span class="visually-hidden">{{ 'products.product.price.unit_price' | t }}</span>
                                          {{ item.variant.unit_price | money }}
                                          <span aria-hidden="true">/</span>
                                          <span class="visually-hidden"
                                            >&nbsp;{{ 'accessibility.unit_price_separator' | t }}&nbsp;</span
                                          >
                                          {%- if item.variant.unit_price_measurement.reference_value != 1 -%}
                                            {{- item.variant.unit_price_measurement.reference_value -}}
                                          {%- endif -%}
                                          {{ item.variant.unit_price_measurement.reference_unit }}
                                        </div>
                                      {%- endif -%}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </li>
                          {%- endfor -%}
                        </ul>
                      </div>
                    {%- endif -%}
                    <p id="CartDrawer-LiveRegionText" class="visually-hidden" role="status"></p>
                    <p id="CartDrawer-LineItemStatus" class="visually-hidden" aria-hidden="true" role="status">
                      {{ 'accessibility.loading' | t }}
                    </p>
                  </div>
                  <div id="CartDrawer-CartErrors" role="alert"></div>
                </form>
              </cart-drawer-items>
            {% when 'in_cart_upsell' %}
              {% liquid
                assign show_upsell = false

                # Check display rules
                if block.settings.display_rule == 'always'
                  assign show_upsell = true
                elsif block.settings.display_rule == 'product_specific'
                  assign target_handles = block.settings.target_product_handles | replace: ' ', '' | split: ','
                  for item in cart.items
                    if target_handles contains item.product.handle
                      assign show_upsell = true
                      break
                    endif
                  endfor
                elsif block.settings.display_rule == 'collection_specific'
                  for item in cart.items
                    for collection in item.product.collections
                      if collection.id == block.settings.target_collection.id
                        assign show_upsell = true
                        break
                      endif
                    endfor
                    if show_upsell
                      break
                    endif
                  endfor
                elsif block.settings.display_rule == 'cart_value'
                  if cart.total_price >= block.settings.min_cart_value
                    assign show_upsell = true
                  endif
                endif

                # Check if upsell product is already in cart
                assign upsell_in_cart = false
                if block.settings.upsell_product != blank
                  for item in cart.items
                    if item.product.id == block.settings.upsell_product.id
                      assign upsell_in_cart = true
                      break
                    endif
                  endfor
                endif
              %}

              {% if show_upsell and upsell_in_cart == false and block.settings.upsell_product != blank %}
                {% assign upsell_variant = block.settings.upsell_product.selected_or_first_available_variant %}
                {% if block.settings.upsell_variant_id != blank %}
                  {% for variant in block.settings.upsell_product.variants %}
                    {% if variant.id == block.settings.upsell_variant_id %}
                      {% assign upsell_variant = variant %}
                    {% endif %}
                  {% endfor %}
                {% endif %}

                <div class="cart-drawer__in-cart-upsell"
                     data-processing="false"
                     style="--icup-bg: {{ block.settings.background_color }};
                            --icup-border: {{ block.settings.border_color }};
                            --icup-text: {{ block.settings.text_color }};
                            --icup-accent: {{ block.settings.accent_color }};
                            --icup-checkbox: {{ block.settings.checkbox_color }};
                            --icup-radius: {{ block.settings.border_radius }}px;
                            --icup-padding: {{ block.settings.padding }}px;
                            --icup-margin-top: {{ block.settings.margin_top }}px;
                            --icup-margin-bottom: {{ block.settings.margin_bottom }}px;"
                     {{ block.shopify_attributes }}>
                  <label class="cart-drawer__in-cart-upsell__label{% if block.settings.auto_check %} is-auto-checked{% endif %}">
                    <input type="checkbox"
                           class="cart-drawer__in-cart-upsell__checkbox"
                           data-variant-id="{{ upsell_variant.id }}"
                           data-product-id="{{ block.settings.upsell_product.id }}"
                           {% if block.settings.auto_check %}checked{% endif %}>
                    <span class="cart-drawer__in-cart-upsell__content">
                      {% if block.settings.show_icon %}
                        <span class="cart-drawer__in-cart-upsell__icon">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                          </svg>
                        </span>
                      {% endif %}
                      <span class="cart-drawer__in-cart-upsell__text">
                        {{ block.settings.offer_text }}
                        <span class="cart-drawer__in-cart-upsell__price">{{ block.settings.offer_price }}</span>
                      </span>
                    </span>
                  </label>
                </div>
              {% endif %}

            {% when 'product_upsells' %}
              {% if block.settings.position == 'body' %}
                {% liquid
                  if block.settings.display == 'globally'
                    assign display = true
                  else
                    assign display = false
                    assign handles_array = block.settings.display_product_handles | replace: ' ', '' | split: ','
                    if handles_array contains product.handle
                      assign display = true
                    endif
                  endif
                %}
                {% if display %}
                  {% render 'upsell-block', block: block, type: 'cart-drawer' %}
                {% endif %}
              {% endif %}
            {% when 'gift' %}
              {% if block.settings.position == 'body' %}
                {% liquid
                  if block.settings.display == 'globally'
                    assign display = true
                  else 
                    assign display = false
                    assign handles_array = block.settings.display_product_handles | replace: ' ', '' | split: ','
                    if handles_array contains product.handle
                      assign display = true
                    endif
                  endif
                %}
                {% if display %}
                  {% render 'cart-gift', block: block, items_count: non_upsell_count %}
                {% endif %}
              {% endif %}
            {%- when 'text_with_icon' -%}
              {% if block.settings.position == 'body' %}
                {% render 'text-with-icon-block', block: block, margins: true, block_attributes: true %}
              {% endif %}
            {% when 'image' %}
              {% if block.settings.position == 'body' %}
                <div 
                  class="product-info__image-block" 
                  style="--image-width:{{ block.settings.width }}%;--image-alignment:{{ block.settings.alignment }};--border-radius:{{ block.settings.border_radius | divided_by: 10.0 }}rem;--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;"
                  {{ block.shopify_attributes }} 
                >
                  {% if block.settings.image != blank %}
                    <div class="media media--transparent ratio" style="--ratio-percent: {{ 1 | divided_by: block.settings.image.aspect_ratio | times: 100 }}%">
                      {%- capture sizes -%}
                        (min-width: {% if section.settings.desktop_width == 'normal' %}430{% else %}580{% endif %}px) calc(370px * {{ block.settings.width | divided_by: 100 }}),
                        calc((100vw - {% if section.settings.mobile_width == 'partial' %}60{% else %}30{% endif %}px) * {{ block.settings.width | divided_by: 100 }})
                      {%- endcapture -%}
                      {{
                        block.settings.image
                        | image_url: width: 1500
                        | image_tag: loading: 'lazy', sizes: sizes, widths: '165, 360, 535, 750, 1070, 1250, 1500'
                      }}
                    </div>
                  {% else %}
                    {{ 'image' | placeholder_svg_tag: 'placeholder-svg placeholder' }}
                  {% endif %}
                </div>
              {% endif %}
            {%- when 'icon_with_text' -%}
              {% if block.settings.position == 'body' %}
                {% render 'icon-with-text',
                  block: block
                %}
              {% endif %}
            {%- when 'custom_liquid' -%}
              {% if block.settings.position == 'body' %}
                {{ block.settings.custom_liquid }}
              {% endif %}
          {% endcase %}
        {% endfor %}
      </div>
      <div class="drawer__footer">
        {% for block in section.blocks %}
          {% case block.type %}
            {% when 'discount_field' %}
              {% render 'cart-discount-field', block: block %}
            {% when 'cart_note' %}
              <details id="Details-CartDrawer" style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" {{ block.shopify_attributes }}>
                <summary>
                  <span class="summary__title">
                    {{ 'sections.cart.note' | t }}
                    {% render 'icon-caret' %}
                  </span>
                </summary>
                <cart-note class="cart__note field">
                  <label class="visually-hidden" for="CartDrawer-Note">{{ 'sections.cart.note' | t }}</label>
                  <textarea
                    id="CartDrawer-Note"
                    class="text-area text-area--resize-vertical field__input"
                    name="note"
                    placeholder="{{ 'sections.cart.note' | t }}"
                  >{{ cart.note }}</textarea>
                </cart-note>
              </details>
            {% when 'subtotals' %}
              <div id="CartDrawer-Footer-{{ block.id }}" class="cart-drawer__footer" style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" {{ block.shopify_attributes }} data-total-price="{{ cart.total_price }}">
                <div class="cart-drawer__totals{% if block.settings.savings_position == 'bellow' %} cart-drawer__totals--reverse{% endif %}" role="status" style='--spacing:{{ block.settings.savings_spacing | divided_by: 10.0 }}rem;'>
                  {% if block.settings.display_total_savings %}
                    {% assign total_savings = total_compare_price | minus: cart.total_price %}
                    {% if total_savings > 0 %}
                      {% capture savings_money %}<span class='cart-drawer__totals__row__money' data-savings-amount="{{ total_savings }}">{{ total_savings | money }}</span>{% endcapture %}
                      <p class='cart-drawer__totals__row cart-drawer__totals__row--{{ block.settings.savings_alignment }} text-color-{{ block.settings.savings_text_color }}' style='--text-size:{{ block.settings.savings_text_size | divided_by: 10.0 }}rem;'>
                        <span>{{ block.settings.savings_left_text | replace: '[savings]', savings_money }}</span><span>{{ block.settings.savings_right_text | replace: '[savings]', savings_money }}</span>
                      </p>
                    {% endif %}
                  {% endif %}
                  {% if block.settings.display_subtotal %}
                    {% capture subtotal_money %}<span class='cart-drawer__totals__row__money cart-drawer__subtotal-amount' data-total-price="{{ cart.total_price }}">{{ cart.total_price | money }}</span>{% endcapture %}
                    <p class='cart-drawer__totals__row cart-drawer__totals__row--{{ block.settings.subtotal_alignment }} text-color-{{ block.settings.subtotal_text_color }}' style='--text-size:{{ block.settings.subtotal_text_size | divided_by: 10.0 }}rem;'>
                      <span>{{ block.settings.subtotal_left_text | replace: '[subtotal]', subtotal_money }}</span><span>{{ block.settings.subtotal_right_text | replace: '[subtotal]', subtotal_money }}</span>
                    </p>
                  {% endif %}
                </div>
                {%- if block.settings.display_discounts and cart.cart_level_discount_applications.size > 0 -%}
                  <div class="cart-drawer__discounts cart-drawer__footer__discounts list-unstyled" style='--alignment:{{ block.settings.discounts_alignment }};' role="list" aria-label="{{ 'customer.order.discount' | t }}">
                    <span class='cart-drawer__discounts__label'>{{ block.settings.discounts_label }}</span>
                    {%- for discount in cart.cart_level_discount_applications -%}
                      <div class="badge">
                        {%- render 'icon-discount' -%}
                        <span>{{ discount.title }} (-{{ discount.total_allocated_amount | money }})</span>
                      </div>
                    {%- endfor -%}
                  </div>
                {%- endif -%}
                {% if block.settings.display_total_savings %}
                  {% capture total_savings_money %}
                    {{ total_compare_price | minus: cart.total_price | money_without_trailing_zeros }}
                  {% endcapture %}
                  <p class='cart-drawer__total-savings {{ block.settings.savings_alignment }} text-color-{{ block.settings.savings_text_color }}'>
                    {{ block.settings.savings_text | replace: '[amount]', total_savings_money }}
                  </p>
                {% endif %}
              </div>
            {% when 'checkout_btn' %}
              <style>
                {% if block.settings.enable_custom_color %}
                  #CartDrawer-Checkout {
                    --color-button: {{ block.settings.custom_color.red }}, {{ block.settings.custom_color.green }}, {{ block.settings.custom_color.blue }};
                  }
                {% endif %}
                #CartDrawer-Checkout {
                  --icon-scale: {{ block.settings.icon_scale | divided_by: 100.0 }}em;
                  --icon-spacing: {{ block.settings.icon_spacing }}px;
                }
                {% if block.settings.prefix_icon != blank %}
                  #CartDrawer-Checkout .button__label::before {
                    background-image: url('{{ block.settings.prefix_icon | image_url }}');
                  }
                {% endif %}
                {% if block.settings.suffix_icon != blank %}
                  #CartDrawer-Checkout .button__label::after {
                    background-image: url('{{ block.settings.suffix_icon | image_url }}');
                  }
                {% endif %}

                /* Magic Mind Style for Checkout Button */
                #CartDrawer-Checkout {
                  position: relative;
                  display: inline-flex;
                  align-items: center;
                  justify-content: center;
                  padding: 14px 32px;
                  font-size: 15px;
                  font-weight: 600;
                  letter-spacing: 0.02em;
                  text-decoration: none;
                  text-transform: none;
                  border: 2px solid #7B92C8;
                  border-radius: 8px;
                  color: #ffffff;
                  background: #7B92C8;
                  cursor: pointer;
                  transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                  overflow: hidden;
                  z-index: 1;
                  width: 100%;
                }

                #CartDrawer-Checkout::before {
                  content: '';
                  position: absolute;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  background: linear-gradient(135deg, #7B92C8 0%, #ddbea8 50%, #f3dfc1 100%);
                  background-size: 200% 200%;
                  opacity: 0;
                  transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                  z-index: -1;
                }

                #CartDrawer-Checkout:hover::before {
                  opacity: 1;
                  background-position: 100% 0;
                  animation: gradientShiftCheckout 0.6s ease forwards;
                }

                #CartDrawer-Checkout:hover {
                  color: #ffffff !important;
                  border-color: transparent !important;
                  transform: translateY(-2px);
                  box-shadow: 0 8px 24px rgba(123, 146, 200, 0.3);
                }

                #CartDrawer-Checkout:disabled {
                  opacity: 0.5;
                  cursor: not-allowed;
                  transform: none;
                }

                #CartDrawer-Checkout:disabled:hover {
                  color: #7B92C8 !important;
                  border-color: #7B92C8 !important;
                  transform: none;
                  box-shadow: none;
                }

                #CartDrawer-Checkout:disabled:hover::before {
                  opacity: 0;
                  animation: none;
                }

                @keyframes gradientShiftCheckout {
                  0% { background-position: 0% 50%; }
                  100% { background-position: 100% 50%; }
                }

                @media screen and (max-width: 749px) {
                  #CartDrawer-Checkout {
                    padding: 12px 24px;
                    font-size: 14px;
                  }
                }
              </style>
              <div class="cart__ctas" style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" {{ block.shopify_attributes }}>
                <noscript>
                  <button type="submit" class="cart__update-button button button--secondary" form="CartDrawer-Form">
                    {{ 'sections.cart.update' | t }}
                  </button>
                </noscript>
                <div class='tnc-checkbox-warning tnc-checkbox-warning--above-button hidden' style='margin-bottom: 0.6em;'></div>
                <button
                  type="submit"
                  id="CartDrawer-Checkout"
                  class="cart__checkout-button{% if block.settings.prefix_icon != blank %} button--prefix-icon{% endif %}{% if block.settings.suffix_icon != blank %} button--suffix-icon{% endif %}"
                  name="checkout"
                  form="CartDrawer-Form"
                  {% if cart == empty %}
                    disabled
                  {% endif %}
                >
                  <span class='button__label'>
                    {{ 'sections.cart.checkout' | t }}
                    {% if block.settings.display_price %}
                      â€¢ {{ cart.total_price | money }}
                    {% endif %}
                  </span>
                </button>
                {%- if block.settings.show_additional_checkout_buttons and additional_checkout_buttons -%}
                  <div class="cart__dynamic-checkout-buttons additional-checkout-buttons">
                    {{ content_for_additional_checkout_buttons }}
                  </div>
                {%- endif -%}
                <div class='tnc-checkbox-warning tnc-checkbox-warning--under-button hidden' style='margin-top: 0.6em;'></div>
              </div>
            {%- when 'payment_badges' -%}
              <style>
                .payment-badges .list-payment__item svg {
                  filter: grayscale(100%);
                  opacity: 0.7;
                  transition: filter 0.3s ease, opacity 0.3s ease;
                }
                .payment-badges .list-payment__item:hover svg {
                  filter: grayscale(0%);
                  opacity: 1;
                }
              </style>
              <div class='payment-badges-block' style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" {{ block.shopify_attributes }}>
                <ul class="payment-badges" role="list">
                  {% assign enabled_payment_types = shop.enabled_payment_types %}
                  {% if block.settings.enabled_payment_types != blank %}
                    {% assign enabled_payment_types = block.settings.enabled_payment_types | remove: ' ' | split: ',' %}
                  {% endif %}

                  {%- for type in enabled_payment_types -%}
                    {% assign payment_type = type | strip %}
                    <li class="list-payment__item">
                      {{ payment_type | payment_type_svg_tag: class: 'icon icon--full-color' }}
                    </li>
                  {%- endfor -%}
                </ul>
              </div>
            {%- when 'tnc_checkbox' -%}
              <div style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" {{ block.shopify_attributes }}>
                <style>
                  .tnc-chekcbox {
                    font-size: {{ block.settings.checkbox_text_size | divided_by: 10.0 }}rem;
                  }
                  .tnc-checkbox-warning {
                    font-size: {{ block.settings.warning_text_size | divided_by: 10.0 }}rem;
                    text-align: {{ block.settings.warning_alignment }};
                    color: {{ block.settings.warning_text_color }};
                  }
                </style>
                <tnc-chekcbox
                  class='tnc-chekcbox flex flex-align-center{% if block.settings.checkbox_alignment == 'center' %} center flex-justify-center{% endif %}'
                  data-checked="false"
                  data-disable-button="{{ block.settings.disable_checkout_button }}"
                  data-warning-text='{{ block.settings.warning_text }}'
                  data-warning-position='{{ block.settings.warning_position }}'
                >
                  <svg
                    class="checkmark-checked text-color-{{ block.settings.checkbox_color }} flex-shrink-0"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 448 512"
                    fill="currentColor"
                    width="50"
                    height="50"
                  >
                    <path d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM337 209L209 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L303 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
                  </svg>
                  <svg
                    class="checkmark-unchecked text-color-{{ block.settings.checkbox_color }} flex-shrink-0"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 448 512"
                    fill="currentColor"
                    width="50"
                    height="50"
                  >
                    <path d="M384 80c8.8 0 16 7.2 16 16V416c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V96c0-8.8 7.2-16 16-16H384zM64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64z"/>
                  </svg>
                  <p class="tnc-checkbox__text margin-0">
                    {{ block.settings.checkbox_text }}
                  </p>
                </tnc-chekcbox>
                <div class='tnc-checkbox-warning tnc-checkbox-warning--under-checkbox hidden' style='margin-top: 0.4em;'></div>
              </div>
            {%- when 'trust_signals' -%}
              {% if section.settings.enable_trust_signals %}
                <div class="cart-drawer__trust-signals" style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" {{ block.shopify_attributes }}>
                  {% if block.settings.show_secure_checkout %}
                    <div class="cart-drawer__trust-signal">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                      </svg>
                      <span>{{ block.settings.secure_checkout_text | default: 'Secure checkout' }}</span>
                    </div>
                  {% endif %}
                  {% if block.settings.show_guarantee %}
                    <div class="cart-drawer__trust-signal">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      <span>{{ block.settings.guarantee_text | default: '30-day money back guarantee' }}</span>
                    </div>
                  {% endif %}
                  {% if block.settings.show_free_returns %}
                    <div class="cart-drawer__trust-signal">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 14 4 9 9 4"></polyline>
                        <path d="M20 20v-7a4 4 0 0 0-4-4H4"></path>
                      </svg>
                      <span>{{ block.settings.free_returns_text | default: 'Free returns' }}</span>
                    </div>
                  {% endif %}
                </div>
              {% endif %}
            {% when 'product_upsells' %}
              {% if block.settings.position == 'footer' %}
                {% liquid
                  if block.settings.display == 'globally'
                    assign display = true
                  else 
                    assign display = false
                    assign handles_array = block.settings.display_product_handles | replace: ' ', '' | split: ','
                    if handles_array contains product.handle
                      assign display = true
                    endif
                  endif
                %}
                {% if display %}
                  {% render 'upsell-block', block: block, type: 'cart-drawer' %}
                {% endif %}
              {% endif %}
            {% when 'gift' %}
              {% if block.settings.position == 'footer' %}
                {% liquid
                  if block.settings.display == 'globally'
                    assign display = true
                  else 
                    assign display = false
                    assign handles_array = block.settings.display_product_handles | replace: ' ', '' | split: ','
                    if handles_array contains product.handle
                      assign display = true
                    endif
                  endif
                %}
                {% if display %}
                  {% render 'cart-gift', block: block, items_count: non_upsell_count %}
                {% endif %}
              {% endif %}
            {%- when 'text_with_icon' -%}
              {% if block.settings.position == 'footer' %}
                {% render 'text-with-icon-block', block: block, margins: true, block_attributes: true %}
              {% endif %}
            {% when 'image' %}
              {% if block.settings.position == 'footer' %}
                <div 
                  class="product-info__image-block" 
                  style="--image-width:{{ block.settings.width }}%;--image-alignment:{{ block.settings.alignment }};--border-radius:{{ block.settings.border_radius | divided_by: 10.0 }}rem;--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;"
                  {{ block.shopify_attributes }} 
                >
                  {% if block.settings.image != blank %}
                    <div class="media media--transparent ratio" style="--ratio-percent: {{ 1 | divided_by: block.settings.image.aspect_ratio | times: 100 }}%">
                      {%- capture sizes -%}
                        (min-width: {% if section.settings.desktop_width == 'normal' %}430{% else %}580{% endif %}px) calc(370px * {{ block.settings.width | divided_by: 100 }}),
                        calc((100vw - {% if section.settings.mobile_width == 'partial' %}60{% else %}30{% endif %}px) * {{ block.settings.width | divided_by: 100 }})
                      {%- endcapture -%}
                      {{
                        block.settings.image
                        | image_url: width: 1500
                        | image_tag: loading: 'lazy', sizes: sizes, widths: '165, 360, 535, 750, 1070, 1250, 1500'
                      }}
                    </div>
                  {% else %}
                    {{ 'image' | placeholder_svg_tag: 'placeholder-svg placeholder' }}
                  {% endif %}
                </div>
              {% endif %}
            {%- when 'icon_with_text' -%}
              {% if block.settings.position == 'footer' %}
                {% render 'icon-with-text',
                  block: block
                %}
              {% endif %}
            {%- when 'custom_liquid' -%}
              {% if block.settings.position == 'footer' %}
                {{ block.settings.custom_liquid }}
              {% endif %}
          {% endcase %}
        {% endfor %}
        <!-- end footer -->
      </div>
    </div>
  </div>
</cart-drawer>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    function isIE() {
      const ua = window.navigator.userAgent;
      const msie = ua.indexOf('MSIE ');
      const trident = ua.indexOf('Trident/');

      return msie > 0 || trident > 0;
    }

    if (!isIE()) return;
    const cartSubmitInput = document.createElement('input');
    cartSubmitInput.setAttribute('name', 'checkout');
    cartSubmitInput.setAttribute('type', 'hidden');
    document.querySelector('#cart').appendChild(cartSubmitInput);
    document.querySelector('#checkout').addEventListener('click', function (event) {
      document.querySelector('#cart').submit();
    });
  });

  // Fix for subtotal and line item prices not updating when quantity changes
  (function() {
    // Helper to format money
    function formatMoney(cents) {
      const value = (cents / 100).toFixed(2).replace('.', ',');
      return 'â‚¬' + value;
    }


    // Helper function to format money
    function formatCartMoney(cents) {
      const shopCurrency = window.Shopify?.currency?.active || 'EUR';
      const value = (cents / 100).toFixed(2);
      if (shopCurrency === 'EUR') {
        return 'â‚¬' + value.replace('.', ',');
      } else if (shopCurrency === 'USD' || shopCurrency === 'GBP') {
        return (shopCurrency === 'USD' ? '$' : 'Â£') + value;
      }
      return value + ' ' + shopCurrency;
    }

    // In-Cart Upsell functionality - Track in-flight requests globally
    const inFlightUpsellRequests = new Set();

    document.addEventListener('change', function(e) {
      const checkbox = e.target.closest('.cart-drawer__in-cart-upsell__checkbox');
      if (!checkbox) return;

      const upsellContainer = checkbox.closest('.cart-drawer__in-cart-upsell');
      const variantId = checkbox.dataset.variantId;

      if (!variantId || !upsellContainer) return;

      // Prevent double submission - check both container state and global tracking
      if (upsellContainer.dataset.processing === 'true' || inFlightUpsellRequests.has(variantId)) {
        console.log('Upsell request already in flight for variant:', variantId);
        return;
      }

      // Disable checkbox during processing to prevent rapid clicks
      checkbox.disabled = true;
      upsellContainer.classList.add('is-loading');
      upsellContainer.dataset.processing = 'true';
      inFlightUpsellRequests.add(variantId);

      if (checkbox.checked) {
        // ADD the upsell product to cart
        // Calculate quantity needed based on non-hidden items in cart
        fetch('/cart.js')
          .then(response => response.json())
          .then(cart => {
            // Count all items (for warranties, we add 1 per item in cart)
            let mainProductQuantity = 0;
            cart.items.forEach(item => {
              // Skip the warranty itself when counting
              if (item.variant_id != variantId) {
                mainProductQuantity += item.quantity;
              }
            });

            // Check how many warranties are already in cart
            let existingWarrantyQty = 0;
            cart.items.forEach(item => {
              if (item.variant_id == variantId) {
                existingWarrantyQty = item.quantity;
              }
            });

            // Calculate how many more warranties to add
            const quantityToAdd = mainProductQuantity - existingWarrantyQty;

            if (quantityToAdd <= 0) {
              // Already have enough warranties
              upsellContainer.classList.remove('is-loading');
              upsellContainer.classList.add('is-added');
              checkbox.disabled = false;
              upsellContainer.dataset.processing = 'false';
              inFlightUpsellRequests.delete(variantId);
              return updateCartAfterUpsell(cart, upsellContainer);
            }

            // Add the calculated quantity
            return fetch('/cart/add.js', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({
                id: variantId,
                quantity: quantityToAdd
              })
            });
          })
          .then(response => {
            if (!response) return; // Already handled above
            return response.json();
          })
          .then(data => {
            if (!data) return; // Already handled above
            upsellContainer.classList.remove('is-loading');
            upsellContainer.classList.add('is-added');
            checkbox.disabled = false;
            upsellContainer.dataset.processing = 'false';
            inFlightUpsellRequests.delete(variantId);
            return fetch('/cart.js');
          })
          .then(response => {
            if (!response) return;
            return response.json();
          })
          .then(cart => {
            if (cart) {
              // Refresh cart UI dynamically instead of page reload
              updateCartAfterUpsell(cart, upsellContainer);
              // Dispatch event for other components
              document.dispatchEvent(new CustomEvent('cart:updated', { detail: cart }));
            }
          })
          .catch(err => {
            console.error('In-cart upsell add error:', err);
            upsellContainer.classList.remove('is-loading');
            upsellContainer.dataset.processing = 'false';
            inFlightUpsellRequests.delete(variantId);
            checkbox.disabled = false;
            checkbox.checked = false;
            alert('Sorry, we could not add this item to your cart. Please try again.');
          });
      } else {
        // REMOVE the upsell product from cart
        fetch('/cart.js')
          .then(response => response.json())
          .then(cart => {
            let lineItem = null;
            for (let i = 0; i < cart.items.length; i++) {
              if (cart.items[i].variant_id == variantId) {
                lineItem = cart.items[i];
                lineItem.line = i + 1;
                break;
              }
            }

            if (lineItem) {
              // Use updates object with variant ID instead of line parameter (line becomes invalid when cart changes)
              const updates = {};
              updates[variantId] = 0;
              return fetch('/cart/update.js', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Accept': 'application/json'
                },
                body: JSON.stringify({
                  updates: updates
                })
              });
            } else {
              // Item not in cart, just update UI
              upsellContainer.classList.remove('is-loading', 'is-added');
              checkbox.disabled = false;
              upsellContainer.dataset.processing = 'false';
              inFlightUpsellRequests.delete(variantId);
              return null;
            }
          })
          .then(response => {
            if (!response) return null;
            return response.json();
          })
          .then(cart => {
            if (!cart) return;
            // Refresh cart UI dynamically instead of page reload
            updateCartAfterUpsell(cart, upsellContainer);
            // Dispatch event for other components
            document.dispatchEvent(new CustomEvent('cart:updated', { detail: cart }));
          })
          .catch(err => {
            console.error('In-cart upsell remove error:', err);
            upsellContainer.classList.remove('is-loading');
            upsellContainer.dataset.processing = 'false';
            inFlightUpsellRequests.delete(variantId);
            checkbox.disabled = false;
            checkbox.checked = true;
            alert('Sorry, we could not remove this item. Please try again.');
          });
      }
    });

    // Helper function to update cart UI after upsell change
    function updateCartAfterUpsell(cart, upsellContainer) {
      // Update cart heading count
      const heading = document.querySelector('.drawer__heading');
      if (heading) {
        const nonUpsellCount = cart.items.reduce(function(sum, item) {
          const isHidden = item.tags && item.tags.includes('cart-hidden');
          return isHidden ? sum : sum + item.quantity;
        }, 0);
        let newText = heading.textContent.replace(/\d+/, nonUpsellCount);
        if (nonUpsellCount === 1) {
          newText = newText.replace(/\bitems\b/, 'item');
        } else {
          newText = newText.replace(/\bitem\b(?!s)/, 'items');
        }
        heading.textContent = newText;
      }

      // Update subtotal amount
      const subtotalAmount = document.querySelector('.cart-drawer__subtotal-amount');
      if (subtotalAmount) {
        subtotalAmount.textContent = formatCartMoney(cart.total_price);
        subtotalAmount.setAttribute('data-total-price', cart.total_price);
      }

      // Also update any other price displays
      const totalMoneyElements = document.querySelectorAll('.cart-drawer__totals__row__money[data-total-price]');
      totalMoneyElements.forEach(function(el) {
        el.textContent = formatCartMoney(cart.total_price);
        el.setAttribute('data-total-price', cart.total_price);
      });

      // Update cart icon bubble
      const cartIconBubble = document.getElementById('cart-icon-bubble');
      if (cartIconBubble) {
        const bubble = cartIconBubble.querySelector('.cart-count-bubble');
        if (bubble) {
          if (cart.item_count > 0) {
            bubble.textContent = cart.item_count;
            bubble.style.display = 'flex';
          } else {
            bubble.style.display = 'none';
          }
        }
      }

      // Dispatch cart update event
      document.dispatchEvent(new CustomEvent('cart:updated', { detail: cart }));

      return cart;
    }

    // Function to refresh cart sections
    function refreshCartSections() {
      // Fetch updated cart drawer HTML
      fetch(window.location.pathname + '?section_id=cart-drawer')
        .then(response => response.text())
        .then(html => {
          // Parse the new cart content
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');

          // Update cart items count in header
          const cartIconBubble = document.getElementById('cart-icon-bubble');
          if (cartIconBubble) {
            fetch('/cart.js')
              .then(r => r.json())
              .then(cart => {
                const count = cart.item_count;
                const bubble = cartIconBubble.querySelector('.cart-count-bubble');
                if (bubble) {
                  if (count > 0) {
                    bubble.textContent = count;
                    bubble.style.display = 'flex';
                  } else {
                    bubble.style.display = 'none';
                  }
                }
              });
          }
        })
        .catch(err => console.error('Cart refresh error:', err));
    }

    // Listen for the cart drawer opening
    const cartDrawer = document.querySelector('cart-drawer');
    if (cartDrawer) {
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const isOpen = !cartDrawer.classList.contains('is-empty') || cartDrawer.hasAttribute('open');
            if (isOpen) {
              // Sync in-cart upsell checkboxes with actual cart state
              setTimeout(syncInCartUpsellCheckboxes, 150);
            }
          }
        });
      });
      observer.observe(cartDrawer, { attributes: true });
    }

    // Helper function to sync in-cart upsell checkboxes with cart state
    function syncInCartUpsellCheckboxes() {
      fetch('/cart.js')
        .then(response => response.json())
        .then(cart => {
          const upsellCheckboxes = document.querySelectorAll('.cart-drawer__in-cart-upsell__checkbox');
          upsellCheckboxes.forEach(function(checkbox) {
            const variantId = checkbox.dataset.variantId;
            const upsellContainer = checkbox.closest('.cart-drawer__in-cart-upsell');
            if (variantId && upsellContainer) {
              // Reset any stuck processing states
              checkbox.disabled = false;
              upsellContainer.dataset.processing = 'false';
              inFlightUpsellRequests.delete(variantId);

              // Check if this variant is in the cart
              const inCart = cart.items.some(function(item) {
                return item.variant_id == variantId;
              });
              // Update checkbox and visual state to match cart
              checkbox.checked = inCart;
              if (inCart) {
                upsellContainer.classList.add('is-added');
              } else {
                upsellContainer.classList.remove('is-added');
              }
            }
          });
        })
        .catch(err => console.error('Error syncing upsell checkboxes:', err));
    }

    // Listen for cart updates to auto-adjust warranty quantities
    document.addEventListener('cart:updated', function(e) {
      const cart = e.detail;
      if (!cart) return;

      // Find all upsell checkboxes
      const checkboxes = document.querySelectorAll('.cart-drawer__in-cart-upsell__checkbox');
      if (!checkboxes.length) return;

      // Process each checkbox - only apply auto-adjust to warranty/guarantee upsells
      checkboxes.forEach(function(checkbox) {
        const upsellContainer = checkbox.closest('.cart-drawer__in-cart-upsell');
        const variantId = checkbox.dataset.variantId;

        // Only proceed if checkbox is checked
        if (!checkbox.checked || !upsellContainer || !variantId) return;

        // Check if this is a warranty-type upsell by looking at the offer text
        const offerText = upsellContainer.querySelector('.cart-drawer__in-cart-upsell__text')?.textContent?.toLowerCase() || '';
        const isWarranty = offerText.includes('warranty') || offerText.includes('guarantee') || offerText.includes('protecciÃ³n') || offerText.includes('garantÃ­a');

        // Only auto-adjust for warranty-type upsells
        if (!isWarranty) return;

      // Calculate required warranty quantity based on main products
      let mainProductQuantity = 0;
      cart.items.forEach(item => {
        // Skip the warranty itself when counting
        if (item.variant_id != variantId) {
          mainProductQuantity += item.quantity;
        }
      });

      // Check how many warranties are currently in cart
      let existingWarrantyQty = 0;
      cart.items.forEach(item => {
        if (item.variant_id == variantId) {
          existingWarrantyQty = item.quantity;
        }
      });

      // Calculate how many more warranties are needed
      const quantityDifference = mainProductQuantity - existingWarrantyQty;

      // If we need more warranties, add them
      if (quantityDifference > 0) {
        // Prevent concurrent updates
        if (upsellContainer.dataset.processing === 'true' || inFlightUpsellRequests.has(variantId)) {
          return;
        }

        upsellContainer.classList.add('is-loading');
        upsellContainer.dataset.processing = 'true';
        inFlightUpsellRequests.add(variantId);

        fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            id: variantId,
            quantity: quantityDifference
          })
        })
        .then(response => response.json())
        .then(() => {
          return fetch('/cart.js');
        })
        .then(response => response.json())
        .then(updatedCart => {
          upsellContainer.classList.remove('is-loading');
          upsellContainer.dataset.processing = 'false';
          inFlightUpsellRequests.delete(variantId);
          // Refresh the cart UI
          updateCartAfterUpsell(updatedCart, upsellContainer);

          // Update warranty line item display in cart
          const warrantyItem = updatedCart.items.find(item => item.variant_id == variantId);
          if (warrantyItem) {
            // Find warranty cart item by variant ID
            const warrantyCartItem = document.querySelector(`[data-variant-id="${variantId}"]`)?.closest('.cart-item');
            if (warrantyCartItem) {
              // Update quantity input
              const qtyInput = warrantyCartItem.querySelector('.quantity__input');
              if (qtyInput) {
                qtyInput.value = warrantyItem.quantity;
                qtyInput.setAttribute('value', warrantyItem.quantity);
                qtyInput.setAttribute('data-cart-quantity', warrantyItem.quantity);
              }

              // Calculate the correct line item price (unit price * quantity)
              const unitPrice = warrantyItem.final_price || warrantyItem.original_price;
              const linePrice = unitPrice * warrantyItem.quantity;

              // Update line item price - try multiple selectors
              const priceSelectors = [
                '.cart-item__price-wrapper .price--end',
                '.cart-item__price-wrapper .regular-price',
                '.cart-item__totals .price--end',
                '.cart-item__totals .price'
              ];
              let priceDisplay = null;
              for (const selector of priceSelectors) {
                priceDisplay = warrantyCartItem.querySelector(selector);
                if (priceDisplay) break;
              }

              if (priceDisplay) {
                const shopCurrency = window.Shopify?.currency?.active || 'EUR';
                const formatMoney = (cents) => {
                  const value = (cents / 100).toFixed(2);
                  if (shopCurrency === 'EUR') {
                    return 'â‚¬' + value.replace('.', ',');
                  } else if (shopCurrency === 'USD') {
                    return '$' + value;
                  } else if (shopCurrency === 'GBP') {
                    return 'Â£' + value;
                  }
                  return value + ' ' + shopCurrency;
                };
                priceDisplay.textContent = formatMoney(linePrice);
              }
            }
          }
        })
        .catch(err => {
          console.error('Error auto-adding warranty:', err);
          upsellContainer.classList.remove('is-loading');
          upsellContainer.dataset.processing = 'false';
          inFlightUpsellRequests.delete(variantId);
        });
      }
      // If we have too many warranties, remove the excess
      else if (quantityDifference < 0) {
        const quantityToRemove = Math.abs(quantityDifference);

        // Prevent concurrent updates
        if (upsellContainer.dataset.processing === 'true' || inFlightUpsellRequests.has(variantId)) {
          return;
        }

        upsellContainer.classList.add('is-loading');
        upsellContainer.dataset.processing = 'true';
        inFlightUpsellRequests.add(variantId);

        // Calculate new warranty quantity
        const newWarrantyQty = existingWarrantyQty - quantityToRemove;

        // Use cart/change.js to update warranty quantity
        fetch('/cart/change.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            id: variantId,
            quantity: newWarrantyQty
          })
        })
        .then(response => response.json())
        .then(() => {
          return fetch('/cart.js');
        })
        .then(response => response.json())
        .then(updatedCart => {
          upsellContainer.classList.remove('is-loading');
          upsellContainer.dataset.processing = 'false';
          inFlightUpsellRequests.delete(variantId);

          // If no warranties left, uncheck the checkbox
          if (newWarrantyQty <= 0) {
            checkbox.checked = false;
            upsellContainer.classList.remove('is-added');
          }

          // Refresh the cart UI
          updateCartAfterUpsell(updatedCart, upsellContainer);

          // Update warranty line item display in cart
          const warrantyItem = updatedCart.items.find(item => item.variant_id == variantId);
          if (warrantyItem) {
            const warrantyCartItem = document.querySelector(`[data-variant-id="${variantId}"]`)?.closest('.cart-item');
            if (warrantyCartItem) {
              const qtyInput = warrantyCartItem.querySelector('.quantity__input');
              if (qtyInput) {
                qtyInput.value = warrantyItem.quantity;
                qtyInput.setAttribute('value', warrantyItem.quantity);
                qtyInput.setAttribute('data-cart-quantity', warrantyItem.quantity);
              }

              const unitPrice = warrantyItem.final_price || warrantyItem.original_price;
              const linePrice = unitPrice * warrantyItem.quantity;

              const priceSelectors = [
                '.cart-item__price-wrapper .price--end',
                '.cart-item__price-wrapper .regular-price',
                '.cart-item__totals .price--end',
                '.cart-item__totals .price'
              ];
              let priceDisplay = null;
              for (const selector of priceSelectors) {
                priceDisplay = warrantyCartItem.querySelector(selector);
                if (priceDisplay) break;
              }

              if (priceDisplay) {
                const shopCurrency = window.Shopify?.currency?.active || 'EUR';
                const formatMoney = (cents) => {
                  const value = (cents / 100).toFixed(2);
                  if (shopCurrency === 'EUR') {
                    return 'â‚¬' + value.replace('.', ',');
                  } else if (shopCurrency === 'USD') {
                    return '$' + value;
                  } else if (shopCurrency === 'GBP') {
                    return 'Â£' + value;
                  }
                  return value + ' ' + shopCurrency;
                };
                priceDisplay.textContent = formatMoney(linePrice);
              }
            }
          }
        })
        .catch(err => {
          console.error('Error auto-removing warranty:', err);
          upsellContainer.classList.remove('is-loading');
          upsellContainer.dataset.processing = 'false';
          inFlightUpsellRequests.delete(variantId);
        });
      }
      }); // End forEach
    }); // End event listener
  })();

  // Helper function to format money
  function formatMoney(cents) {
    const moneyFormat = {{ shop.money_format | json }};
    const value = (cents / 100).toFixed(2);
    return moneyFormat.replace(/\{\{\s*amount\s*\}\}/g, value).replace(/\{\{\s*amount_no_decimals\s*\}\}/g, Math.round(cents/100));
  }
</script>
